---
title:  "Week-2"
date:   2020-06-08
categories: progess
tags: jekyll
---

# Python Application Builder

## POSIX IPC Implementation
The whole python synthesis was converted into POSIX_IPC implementation instead of shared memory implementation. A major change in the design of the python synthesis was made. Some of the changes were:

- The processes could now run completely independently, as to share memory between processes you only need to know the identifier of the posix shared memory.
- In the previous design we needed to pass shared memory as parameters to functions and each process needed to inherit memory from its parent process which had its own memory overhead.
- In this implementation, each process does not need to inherit memory from its parent process, it just needs to be executed as a script along with the name of the posix shared memory it requires. 
- Each process starts and either it creates the shared memory and starts writing to it or it waits for the shared memory to be created and then starts reading from it. 
- The design was made more modular because in the previous implementation we had to pass memory through parameters so we cannot pass a class as a paramter but the memory got copied to each process instead of getting shared. 
- Now we have a 'Wire' class which handles all race conditions and memory read and write operations for any type of block. 
- Also, there is a metadata structure which handles allocation of memory because to use posix shared memory, the amount of memory must be known before the program starts executing.

### How to execute:
Just download this directory and run using the following command in terminal:
```
python3 main.py
```

### Dependencies:
```
pip install opencv-python
pip install posix_ipc
```

### Example (5 Blocks):
The current example has a color filter and edge detector which read from the same wire on which the camera writes. Then both the color filter and the edge detector write to wires that are read and displayed by the screen block. The video can be found [here](https://youtu.be/7BxmpdifqWM)

## Other Improvements

### Spawning Independent Processes Without Copying Memory:

As in multiprocessing processes, the whole process memory is copied into the child process. In this improvement I will try to run independent processes so they are lightweight and don't inherit memory from the parent process.
Running independent command line processes requires string arguments and not objects.
So, I wrote a custom serializer/deserializer which converts all arguments to a string which can then be passed onto command line and then deserialized back to arguments.


### Fixing Memory Leaks:
The POSIX_IPC uses kernel level commands to share memory between processes. The main issue here was that if I kill the Python processes using the parent process, it would cause memory leak because the shared memory is not released. This is written in the POSIX_IPC documentation:

"You must call close_fd() or os.close() explicitly; the file descriptor is not closed automatically when a SharedMemory object is garbage collected."

So I came up with a way to signal every process to safely terminate and release the shared memory.
Each process will regularly check if the parent process is still alive, if it has exited, all processes will know and then they can safely unlink and de-allocate the shared memory preventing any memory leaks.

## Complete Prototype:
The complete working prototype can be found [here](https://github.com/TheRoboticsClub/colab-gsoc2020-Muhammad_Taha/tree/master/Prototype).
